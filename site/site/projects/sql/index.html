
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>SQL - Bruno Prado - Data Analytics Portfolio</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/css/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#sql" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Bruno Prado - Data Analytics Portfolio" class="md-header__button md-logo" aria-label="Bruno Prado - Data Analytics Portfolio" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Bruno Prado - Data Analytics Portfolio
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SQL
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Bruno Prado - Data Analytics Portfolio" class="md-nav__button md-logo" aria-label="Bruno Prado - Data Analytics Portfolio" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Bruno Prado - Data Analytics Portfolio
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Projects and Skills
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Projects and Skills
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../project1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Task One
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../project3/index.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SQL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../project4/index.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Campaign Analysis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../project5/index.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Attribution Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../project6/index.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Experiment Analysis and Design
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../project2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tag Analysis
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problem-1-define-the-connections-between-the-described-tables-draw-an-erd" class="md-nav__link">
    <span class="md-ellipsis">
      Problem 1: Define the connections between the described tables (draw an ERD)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problem-2-write-queries-that-answer-the-following-questions" class="md-nav__link">
    <span class="md-ellipsis">
      Problem 2: Write queries that answer the following questions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problem-3-calculate-total-revenue-retention-cohort-analysis-and-cumulative-revenue-using-userscsv-and-user_activitiescsv" class="md-nav__link">
    <span class="md-ellipsis">
      Problem 3: Calculate total revenue, retention cohort analysis and cumulative revenue using users.csv and user_activities.csv
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#navigation" class="md-nav__link">
    <span class="md-ellipsis">
      Navigation
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="sql">SQL</h1>
<p>This document contains problems related to:</p>
<ul>
<li>Data Modeling and Entity Relationship Diagram</li>
<li>Categorize users by number of devices</li>
<li>Analyze sessions:<ul>
<li>Users in different apps/games (or in multiple games)</li>
<li>Last session for each user</li>
</ul>
</li>
<li>Calculate cohort metrics:<ul>
<li>Revenue (cohort size = month)</li>
<li>Retention (cohort size = date)</li>
<li>User's Cumulative Revenue from install_date to each activity_date</li>
</ul>
</li>
</ul>
<h2 id="problem-1-define-the-connections-between-the-described-tables-draw-an-erd">Problem 1: Define the connections between the described tables (draw an ERD)</h2>
<details class="abstract">
<summary>Input Tables</summary>
<p><strong>users</strong> :a table holding the entire list of users, including the following columns:</p>
<div class="codehilite"><pre><span></span><code><span class="k">-</span> user_id, username, first_platform, first_install_date, first_cpn_id sessions_cnt, ltv
</code></pre></div>

<p><strong>devices</strong> – a table holding the list of devices and data on their apps installations, including the
following columns:</p>
<div class="codehilite"><pre><span></span><code><span class="k">-</span> device_token, app_id, platform, idfa, gaid, lead_user_id, install_date, cpn_id
</code></pre></div>

<p><strong>apps</strong> – a table holding the different apps of the company, including the following columns:</p>
<div class="codehilite"><pre><span></span><code><span class="k">-</span> app_id, app_name, is_prod, release_date
</code></pre></div>

<p><strong>session_start</strong> – a table holding the events of starting a session in one of the apps, including the
following columns:</p>
<div class="codehilite"><pre><span></span><code><span class="k">-</span> session_id, device_token, app_id, session_start_ts (timestamp)
</code></pre></div>

<p><strong>game_event</strong> – a table holding all the events performed by a user within the game/product, including
the following columns:</p>
<div class="codehilite"><pre><span></span><code><span class="o">-</span><span class="w"> </span><span class="nx">event_id</span><span class="p">,</span><span class="w"> </span><span class="nx">device_token</span><span class="p">,</span><span class="w"> </span><span class="nx">app_id</span><span class="p">,</span><span class="w"> </span><span class="nx">event_type</span><span class="p">,</span><span class="w"> </span><span class="nx">event_name</span><span class="p">,</span><span class="w"> </span><span class="nx">event_ts</span>
</code></pre></div>

</details>
<details class="success">
<summary>Solution</summary>
<p><img alt="chart_erd" src="image_erd.png" /></p>
<p><strong>Primary Keys (PK) and Foreign Keys (FK)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">-</span> Apparently ‘products’ and ‘users’ ‘session_start’ and ‘game_events’ tables have PKs,
<span class="k">-</span> Devices has “device_token”, which at a first sight could look like a PK. However, since
  “device_token” is not unique, it can’t be considered a PK.

  It’s good practice to have a PK defined for every table, it helps with data integrity,
  indexing, and maintaining relationships with other tables. If a table has no PK, there can
  be difficulties when updating or deleting specific rows, and making querying the table
  less efficient.

<span class="k">-</span> Fields with ‘*’ represent assumed keys.
</code></pre></div>

<p><strong>Relationships</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">-</span> users table connects to devices table using a many-to-many relationship.
<span class="k">-</span> devices table connects to session_start table using a one-to-many relationship.
<span class="k">-</span> devices table connects to products table using a many-to-many relationship.
<span class="k">-</span> devices table connects to game_events table using a one-to-many relationship.
<span class="k">-</span> session_start table connects to products table using a many-to-one relationship.
<span class="k">-</span> products table connects to game_events table using a one-to-many relationship.
</code></pre></div>

</details>
<hr />
<h2 id="problem-2-write-queries-that-answer-the-following-questions">Problem 2: Write queries that answer the following questions</h2>
<p>2.1 Present the number of devices per user and add a category value from the following list:
“single device”, “multiple devices”, “no device”</p>
<details class="success">
<summary>Solution</summary>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="n">user_id</span><span class="p">,</span><span class="n">username</span><span class="p">,</span>
<span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">device_token</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">devices</span><span class="p">,</span>
<span class="w">    </span><span class="c1">-- create the category value</span>
<span class="w">    </span><span class="k">CASE</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">device_token</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="ss">&quot;multiple devices&quot;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">device_token</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="ss">&quot;single device&quot;</span>
<span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="ss">&quot;no device&quot;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">category</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">u</span>
<span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">devices</span><span class="w"> </span><span class="n">d</span>
<span class="k">ON</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">lead_user_id</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="n">username</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span>
</code></pre></div>
<p>This solution ensures that all users will be displayed (even the “no device” ones) and includes the
username.</p>
<p>If we replace the LEFT JOIN (more resource intensive) we can improve the query performance,
querying directly the “devices” table. The performance improvement comes with the cost of not having
the username and not having the “no device” users, since they won’t appear in the “devices” table.</p>
<p><div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="w">    </span><span class="n">lead_user_id</span><span class="p">,</span>
<span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">device_token</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">devices</span><span class="p">,</span>
<span class="w">    </span><span class="c1">-- create the category column</span>
<span class="w">    </span><span class="k">CASE</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">device_token</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;no device&#39;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">device_token</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;single device&#39;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">device_token</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;multiple devices&#39;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">device_category</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">devices</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">lead_user_id</span>
</code></pre></div>
Testing both queries in the specific database environment being used is the best way to make an
informed decision, considering both execution time and resource utilization.</p>
</details>
<p>2.2 Return a list of usernames that played (had sessions) in both of the following apps: “crazyrace”,
“epicbattle”. (give 2 different ways)</p>
<details class="success">
<summary>Solution</summary>
<p>Solution 1: Use Common Table Expressions (CTEs) to isolate devices
associated with each game.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="c1">-- create CTE to isolate devices per game</span>
<span class="w">    </span><span class="k">WITH</span>
<span class="w">    </span><span class="n">crazyrace_devices</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">device_token</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">session_start</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;crazyrace&#39;</span><span class="p">),</span>

<span class="w">    </span><span class="n">epicbattle_devices</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">device_token</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">session_start</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;epicbattle&#39;</span><span class="p">),</span>

<span class="w">    </span><span class="n">both_games_devices</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">crazyrace_devices</span>
<span class="w">        </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">epicbattle_devices</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">device_token</span><span class="p">))</span>

<span class="w">    </span><span class="c1">-- Main Query</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">username</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">u</span>
<span class="w">    </span><span class="c1">-- filter only users that played both games</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">lead_user_id</span>
<span class="w">                        </span><span class="k">FROM</span><span class="w"> </span><span class="n">devices</span>
<span class="w">                        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">device_token</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">device_token</span>
<span class="w">                                                </span><span class="k">FROM</span><span class="w"> </span><span class="n">both_games_devices</span><span class="p">))</span>
</code></pre></div>
<p>Solution 2: Use SUBQUERIES and INTERSECT</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">username</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span>
<span class="w">    </span><span class="c1">-- filter crazyrace users</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">lead_user_id</span>
<span class="w">                        </span><span class="k">FROM</span><span class="w"> </span><span class="n">devices</span>
<span class="w">                        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">device_token</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">device_token</span>
<span class="w">                                                </span><span class="k">FROM</span><span class="w"> </span><span class="n">session_start</span>
<span class="w">                                                </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;crazyrace&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="c1">-- get players of both games</span>
<span class="w">    </span><span class="k">INTERSECT</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">username</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span>
<span class="w">    </span><span class="c1">-- filter epicbattle users</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">lead_user_id</span>
<span class="w">                       </span><span class="k">FROM</span><span class="w"> </span><span class="n">devices</span>
<span class="w">                       </span><span class="k">WHERE</span><span class="w"> </span><span class="n">device_token</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">device_token</span>
<span class="w">                                               </span><span class="k">FROM</span><span class="w"> </span><span class="n">session_start</span>
<span class="w">                                               </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;epicbattle&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
</code></pre></div>
</details>
<p>2.3 What is the session_id of the last session per user? (the session_id‘s are not necessarily
ascending according to the session start time)</p>
<details class="success">
<summary>Solution</summary>
<div class="highlight"><pre><span></span><code><span class="k">WITH</span><span class="w"> </span><span class="n">RankSessions</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="cm">/* </span>
<span class="cm">-- This CTE ranks sessions for each user and device-product combination based on the session start timestamp.</span>
<span class="cm">-- It’s important to use device_id and product_id as joining keys together to ensure correct matching,</span>
<span class="cm">   especially in cases where multiple games are played on the same device by different users.</span>
<span class="cm">   For example, the device “ASG13DL” was used by “u1” to install “crazyrace” and “epicbattle”, and used by “u4” to install “golf-race”.</span>
<span class="cm">-- It assigns a row number (rn) to each session, where the most recent session gets rn = 1.</span>
<span class="cm">*/</span>

<span class="k">SELECT</span>
<span class="w">    </span><span class="n">u</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">u</span><span class="p">.</span><span class="n">username</span><span class="p">,</span>
<span class="w">    </span><span class="n">d</span><span class="p">.</span><span class="n">device_token</span><span class="p">,</span>
<span class="w">    </span><span class="n">d</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">session_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">session_start_ts</span><span class="p">,</span>
<span class="w">    </span><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="c1">-- to ensure ranking is done per user. Here we don’t use product_id because we focus on the latest session for each user regardless of the specific product.</span>
<span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">session_start_ts</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="c1">-- to rank the latest session as 1</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rn</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">u</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">devices</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">lead_user_id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">session_start</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">device_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">device_token</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">product_id</span>
<span class="c1">-- If product_id is not used as key, the result will be wrong showing ‘s11’ for both ‘Oliver’ and ‘Sebastian’, because they shared the same device. Examining the data, the correct is ‘Sebastian’ playing ‘golf-race’(s11) and Oliver playing ‘crazyrace’ (s7) for their last sessions.</span>
<span class="p">)</span>

<span class="c1">-- Main Query</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="n">username</span><span class="p">,</span><span class="n">session_id</span><span class="p">,</span><span class="n">session_start_ts</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">RankSessions</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Filter to only include the most recent session for each user</span>
</code></pre></div>
</details>
<hr />
<h2 id="problem-3-calculate-total-revenue-retention-cohort-analysis-and-cumulative-revenue-using-userscsv-and-user_activitiescsv">Problem 3: Calculate total revenue, retention cohort analysis and cumulative revenue using <code>users.csv</code> and <code>user_activities.csv</code></h2>
<details class="abstract">
<summary>Input Tables (samples)</summary>
<p><strong>users</strong>:</p>
<table>
<thead>
<tr>
<th>user_id</th>
<th>install_date</th>
<th>country</th>
</tr>
</thead>
<tbody>
<tr>
<td>abc123</td>
<td>2023-11-17</td>
<td>United States</td>
</tr>
<tr>
<td>xyz999</td>
<td>2023-11-05</td>
<td>Germany</td>
</tr>
<tr>
<td>qwe777</td>
<td>2023-09-28</td>
<td>Spain</td>
</tr>
</tbody>
</table>
<p><strong>user_activities</strong>:</p>
<table>
<thead>
<tr>
<th>user_id</th>
<th>install_date</th>
<th>country</th>
<th>activity_date</th>
<th>revenue</th>
</tr>
</thead>
<tbody>
<tr>
<td>XkiSoEK5f4tyE2ZIOWRs1A==</td>
<td>2024-03-03</td>
<td>Indonesia</td>
<td>2024-03-03</td>
<td>0.00065617357790376837</td>
</tr>
<tr>
<td>UiR+iATpDo8DcYehle/EPw==</td>
<td>2024-03-03</td>
<td>Germany</td>
<td>2024-03-03</td>
<td>0.11618769868339844</td>
</tr>
<tr>
<td>g18jNkYM+fIfzjNkxIxhuQ==</td>
<td>2024-03-02</td>
<td>Hong Kong</td>
<td>2024-03-03</td>
<td>0.013600176580795429</td>
</tr>
</tbody>
</table>
</details>
<p>3.1 Write an SQL query to retrieve the total revenue generated by users who signed up in 2023, grouped by month.</p>
<details class="success">
<summary>Solution</summary>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="w">    </span><span class="k">EXTRACT</span><span class="p">(</span><span class="k">YEAR</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">activity_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">year</span><span class="p">,</span>
<span class="w">    </span><span class="k">EXTRACT</span><span class="p">(</span><span class="k">MONTH</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">activity_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">month</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">revenue</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_revenue</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="o">`</span><span class="n">user_activities</span><span class="o">`</span><span class="w"> </span><span class="n">a</span>
<span class="k">JOIN</span>
<span class="w">    </span><span class="o">`</span><span class="n">users</span><span class="o">`</span><span class="w"> </span><span class="n">u</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">WHERE</span>
<span class="w">    </span><span class="k">EXTRACT</span><span class="p">(</span><span class="k">YEAR</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">install_date</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2023</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span><span class="p">;</span>
</code></pre></div>
<p>output:</p>
<p><img alt="query31" src="query_output_revenue.png" /></p>
</details>
<p>3.2 Using the SQL database, perform a retention cohort analysis to understand user retention over time.</p>
<details class="success">
<summary>Solution</summary>
<div class="highlight"><pre><span></span><code><span class="k">WITH</span><span class="w"> </span><span class="n">user_activities</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>

<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span>
<span class="w">        </span><span class="n">u</span><span class="p">.</span><span class="n">install_date</span><span class="p">,</span>
<span class="w">        </span><span class="n">a</span><span class="p">.</span><span class="n">activity_date</span><span class="p">,</span>
<span class="w">        </span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">activity_date</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">install_date</span><span class="p">,</span><span class="w"> </span><span class="k">DAY</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">days_since_install</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">user_activities</span><span class="w"> </span><span class="n">a</span>
<span class="w">    </span><span class="k">JOIN</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">u</span>
<span class="w">        </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">user_id</span>
<span class="p">),</span>

<span class="n">cohort_sizes</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">install_date</span><span class="p">,</span>
<span class="w">        </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cohort_size</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">install_date</span>
<span class="p">),</span>

<span class="n">active_users</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w">  </span><span class="n">install_date</span><span class="p">,</span>
<span class="w">            </span><span class="n">days_since_install</span><span class="p">,</span>
<span class="w">            </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">active_users</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">user_activities</span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">install_date</span><span class="p">,</span><span class="w"> </span><span class="n">days_since_install</span>
<span class="p">)</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">au</span><span class="p">.</span><span class="n">install_date</span><span class="p">,</span>
<span class="w">    </span><span class="n">au</span><span class="p">.</span><span class="n">days_since_install</span><span class="p">,</span>
<span class="w">    </span><span class="n">cs</span><span class="p">.</span><span class="n">cohort_size</span><span class="p">,</span>
<span class="w">    </span><span class="n">au</span><span class="p">.</span><span class="n">active_users</span><span class="p">,</span>
<span class="w">    </span><span class="n">ROUND</span><span class="p">((</span><span class="n">au</span><span class="p">.</span><span class="n">active_users</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cs</span><span class="p">.</span><span class="n">cohort_size</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">retention_rate_percentage</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">active_users</span><span class="w"> </span><span class="n">au</span>
<span class="k">JOIN</span>
<span class="w">    </span><span class="n">cohort_sizes</span><span class="w"> </span><span class="n">cs</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">au</span><span class="p">.</span><span class="n">install_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cs</span><span class="p">.</span><span class="n">install_date</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="n">au</span><span class="p">.</span><span class="n">install_date</span><span class="p">,</span>
<span class="w">    </span><span class="n">au</span><span class="p">.</span><span class="n">days_since_install</span><span class="p">;</span>
</code></pre></div>
<p>output:</p>
<p><img alt="query32" src="query32.png" /></p>
</details>
<p>3.3 Calculate the cumulative revenue for each user up to each activity date and rank the activities of each user by activity date and show the cumulative revenue.</p>
<details class="success">
<summary>Solution</summary>
<p><div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">activity_date</span><span class="p">,</span>
<span class="w">    </span><span class="n">u</span><span class="p">.</span><span class="n">install_date</span><span class="p">,</span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">revenue</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">revenue</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">activity_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cumulative_revenue</span><span class="p">,</span>
<span class="w">    </span><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">activity_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">activity_rank</span><span class="p">,</span>
<span class="w">    </span><span class="n">DATE_DIFF</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">activity_date</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">install_date</span><span class="p">,</span><span class="w"> </span><span class="k">DAY</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">days_since_install</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">user_activities</span><span class="w"> </span><span class="n">a</span>
<span class="k">JOIN</span>
<span class="w">    </span><span class="n">users</span><span class="w"> </span><span class="n">u</span>
<span class="k">ON</span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">activity_date</span><span class="p">;</span>
</code></pre></div>
output:</p>
<p><img alt="query33" src="query33.png" /></p>
</details>
<hr />
<h2 id="navigation">Navigation</h2>
<p><a href="../../">Previous: Home</a></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
    
  </body>
</html>